# SPDX-License-Identifier: PMPL-1.0-or-later
name: Auto-Detect New Domains

permissions: read-all

on:
  schedule:
    # Run weekly to check for new domains
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:  # Allow manual trigger

jobs:
  detect-and-add:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Check for new domains
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          chmod +x auto-add-new-sites.sh
          ./auto-add-new-sites.sh

      - name: Create Pull Request if new domains found
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f  # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: auto-add new Cloudflare domains

            Detected new domains in Cloudflare account.
            Adding with default configuration (all features disabled).

            Review and customize settings before merging.
          branch: auto-add-domains
          delete-branch: true
          title: "ğŸ¤– New Cloudflare Domains Detected"
          body: |
            ## Auto-Detected New Domains

            This PR adds newly detected domains from your Cloudflare account to `domains.csv`.

            **All domains added with safe defaults:**
            - âœ… Security headers enabled (FREE via Transform Rules)
            - âœ… Standard DNS records (www, cdn, static, etc.)
            - âŒ Workers disabled (enable manually if needed)
            - âŒ Mail disabled (enable manually if needed)
            - âŒ Tunnel disabled (enable manually if needed)

            **Review the domains.csv changes** and customize settings before merging.

            After merge, run:
            ```bash
            terraform plan
            terraform apply
            ```

            ğŸ¤– Auto-generated by auto-detect-new-domains workflow
          labels: automation,infrastructure

      - name: Summary
        run: |
          echo "âœ… Checked for new domains"
          echo "ğŸ“ Created PR if new domains found"
          echo "ğŸ”’ Cost: Still FREE (Transform Rules only)"
